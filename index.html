<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公務車借用系統 - 主選單</title>
    <script src="./js/version.js"></script> 
    <script src="./js/loader.js"></script>
    <!-- 3. 使用載入器動態載入我們自己的 CSS (自動加版本號) -->
    <script>
        loadCSS('./css/index.css');
    </script>
  
</head>
<body>
    <div id="loading-overlay"></div>

    <header class="header">
        <h1>公務車借用系統</h1>
        <p id="welcome-message">載入中...</p>
    </header>

    <main class="nav-menu">
        <!-- 管理員按鈕，預設隱藏 -->
        <a id="admin-menu-button" href="admin.html" class="admin-link" style="display: none;">⚙️ 管理員功能</a>   
        <!-- 使用者按鈕 -->
        <a href="profile.html">📝 個人資料</a>
        <a href="booking.html">📅 預約借車</a>
        <a href="action.html">🔑 領車 / 還車</a>
        <a href="status.html">🔍 查詢我的預約</a>
        <a href="history.html">✍️ 修改歷史記錄</a>
        <a href="upload.html">📷 拍照上傳</a>
        <a href="guide.html">ℹ️ 使用指南</a>
        <a href="#" class="disabled" onclick="event.preventDefault(); alert('此功能即將推出！');">📊 個人統計</a>
        
        
    </main>
    
    <footer class="footer">
        <p>© 台中學院-公務車管理</p>
    </footer>

    <!-- 【關鍵】引入必要的 JS 檔案，並加上版本號 -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="./js/main.js?v=1.0.1"></script>
    
    <!-- 【關鍵】這是屬於 index.html 正確的 JavaScript -->
    <script>
        /**
         * 主選單頁面的初始化函式 (權限判斷版)
         */
        async function initializeIndexPage() {
            // 從 main.js 呼叫 initializeLiff，它會處理載入遮罩
            const liffProfile = await initializeLiff(); 
            
            const welcomeEl = document.getElementById('welcome-message');

            if (!liffProfile) {
                // 如果初始化失敗或需要登入，main.js 會處理，這裡只顯示最終訊息
                if (welcomeEl) welcomeEl.textContent = '載入失敗或需要登入';
                return;
            }

            // 顯示個人化的歡迎訊息
            if (welcomeEl) welcomeEl.textContent = `歡迎，${liffProfile.displayName}`;

            // 呼叫後端 API，檢查使用者身份，以決定是否顯示管理員按鈕
            try {
                const result = await callGasApi('getUserProfile', { userId: liffProfile.userId });

                if (result.status === 'found') {
                    const userStatus = result.data.status;
                    
                    // 只有「管理者」或「開發者」才能看到按鈕
                    if (userStatus === '管理者' || userStatus === '開發者') {
                        const adminButton = document.getElementById('admin-menu-button');
                        if (adminButton) {
                            adminButton.style.display = 'flex'; // 使用 flex 以維持排版一致
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to get user profile for admin check:', error);
            }
        }
        
        // 執行初始化
        initializeIndexPage();
    </script>
</body>
</html>
