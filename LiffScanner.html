<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å…¬å‹™è»Š QR Code æƒæå™¨</title>
  <style>
    /* ç¾ä»£åŒ–çš„ CSS æ¨£å¼ */
    :root {
      --primary-color: #00B900;
      --disabled-color: #BDBDBD;
      --text-color: #333333;
      --error-color: #D32F2F;
      --background-color: #F5F5F5;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: var(--background-color);
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      max-width: 400px;
      width: 100%;
    }
    #status {
      font-size: 1.1em;
      color: var(--text-color);
      margin-bottom: 24px;
      min-height: 40px; /* é¿å…æ–‡å­—æ”¹è®Šæ™‚ä½ˆå±€è·³å‹• */
    }
    #scanBtn {
      width: 100%;
      padding: 16px 32px;
      font-size: 1.2em;
      font-weight: bold;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #scanBtn:disabled {
      background-color: var(--disabled-color);
      cursor: not-allowed;
      box-shadow: none;
    }
    #scanBtn:not(:disabled):hover {
      background-color: #009A00;
    }
    #error {
      margin-top: 20px;
      font-size: 0.9em;
      color: var(--error-color);
      word-wrap: break-word; /* è®“é•·å­—ä¸²èƒ½æ›è¡Œ */
      white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºæ ¼ */
      background-color: #FFEBEE;
      border: 1px solid var(--error-color);
      border-radius: 8px;
      padding: 10px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="status">æ­£åœ¨åˆå§‹åŒ– LIFF ç’°å¢ƒ...</div>
    <button id="scanBtn" disabled onclick="scanQrCode()">ğŸ“· æƒæ QR Code</button>
    <div id="error" class="hidden"></div>
  </div>

  <!-- å¼•ç”¨æœ€æ–°çš„ LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    // ã€é‡è¦ã€‘é€™å€‹ LIFF ID å°‡ç”±å¾Œç«¯ doGet å‡½å¼æ³¨å…¥
    // åœ¨æœ¬åœ°æ¸¬è©¦æ™‚ï¼Œå¯ä»¥æ‰‹å‹•æ›¿æ›æˆæ‚¨çš„ LIFF ID
    const myLiffId = "<?= liffId ?>"; 

    // ç•¶é é¢å®Œå…¨è¼‰å…¥å¾Œï¼ŒåŸ·è¡Œä¸»å‡½å¼
    window.onload = function() {
      main();
    };

    /**
     * ä¸»å‡½å¼ï¼Œè² è²¬åˆå§‹åŒ– LIFF
     */
    async function main() {
      console.log(`[LIFF] Starting initialization with LIFF ID: ${myLiffId}`);
      document.getElementById('status').textContent = 'æ­£åœ¨é©—è­‰æ¬Šé™...';
      
      try {
        // åˆå§‹åŒ– LIFF SDK
        await liff.init({ liffId: myLiffId });
        
        // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥ LINE
        if (!liff.isLoggedIn()) {
          console.log('[LIFF] User not logged in. Redirecting to login page...');
          document.getElementById('status').textContent = 'æ‚¨å°šæœªç™»å…¥ï¼Œå°‡ç‚ºæ‚¨å°å‘ç™»å…¥é é¢...';
          // å¦‚æœæœªç™»å…¥ï¼Œliff.login() æœƒè‡ªå‹•è™•ç†é é¢è·³è½‰
          liff.login(); 
        } else {
          console.log('[LIFF] Initialization successful and user is logged in.');
          document.getElementById('status').textContent = 'âœ… åˆå§‹åŒ–å®Œæˆï¼\nè«‹é»æ“ŠæŒ‰éˆ•æƒæè»Šè¼›ä¸Šçš„ QR Codeã€‚';
          // å•Ÿç”¨æƒææŒ‰éˆ•
          document.getElementById('scanBtn').disabled = false;
        }
      } catch (err) {
        console.error('[LIFF] Initialization failed:', err);
        document.getElementById('status').textContent = 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼';
        document.getElementById('error').textContent = `éŒ¯èª¤è©³æƒ…ï¼š\n${JSON.stringify(err, null, 2)}`;
        document.getElementById('error').classList.remove('hidden');
      }
    }

    /**
     * å•Ÿå‹• QR Code æƒæå™¨ä¸¦è™•ç†å¾ŒçºŒæµç¨‹
     */
    async function scanQrCode() {
      try {
        console.log('[SCAN] Starting QR Code scanner...');
        // åœç”¨æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
        document.getElementById('scanBtn').disabled = true;
        document.getElementById('status').textContent = 'è«‹å°æº– QR Code...';

        // å‘¼å« LIFF çš„æƒæåŠŸèƒ½
        const result = await liff.scanCodeV2();
        
        if (result && result.value) {
          console.log(`[SCAN] Scan successful. Value: ${result.value}`);
          // æƒææˆåŠŸå¾Œï¼Œæç¤ºä½¿ç”¨è€…è¼¸å…¥å…¬é‡Œæ•¸
          const mileage = prompt(`æƒææˆåŠŸï¼å…§å®¹ï¼š${result.value}\n\nè«‹è¼¸å…¥ç›®å‰è»Šè¼›çš„å…¬é‡Œæ•¸ (ç´”æ•¸å­—)ï¼š`, "");

          if (mileage !== null && mileage.trim() !== "" && !isNaN(mileage)) {
            // ä½¿ç”¨è€…è¼¸å…¥äº†æœ‰æ•ˆçš„å…¬é‡Œæ•¸
            const messageToSend = `#scan_result ${result.value} ${mileage.trim()}`;
            console.log(`[SEND] Preparing to send message: ${messageToSend}`);
            document.getElementById('status').textContent = 'æ­£åœ¨å‚³é€è³‡æ–™...';
            
            // é€é LIFF SDK å°‡çµæœä»¥ä½¿ç”¨è€…åç¾©ç™¼é€å›èŠå¤©å®¤
            await liff.sendMessages([{ type: 'text', text: messageToSend }]);
            
            // ç™¼é€æˆåŠŸå¾Œï¼Œé—œé–‰ LIFF è¦–çª—
            liff.closeWindow();
          } else {
            // ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥æˆ–è¼¸å…¥ç„¡æ•ˆ
            console.log('[SCAN] User cancelled input or entered invalid mileage.');
            alert("æ‚¨å–æ¶ˆäº†è¼¸å…¥ï¼Œæˆ–è¼¸å…¥çš„æ ¼å¼ä¸æ­£ç¢ºã€‚");
            // é‡æ–°å•Ÿç”¨æŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é‡è©¦
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('status').textContent = 'âœ… åˆå§‹åŒ–å®Œæˆï¼\nè«‹é»æ“ŠæŒ‰éˆ•æƒæè»Šè¼›ä¸Šçš„ QR Codeã€‚';
          }
        } else {
          // ä½¿ç”¨è€…å¯èƒ½åœ¨æƒæä»‹é¢ä¸­é»äº†ã€Œå–æ¶ˆã€
          console.log('[SCAN] Scanner was closed without a result.');
          // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
          document.getElementById('scanBtn').disabled = false;
          document.getElementById('status').textContent = 'âœ… åˆå§‹åŒ–å®Œæˆï¼\nè«‹é»æ“ŠæŒ‰éˆ•æƒæè»Šè¼›ä¸Šçš„ QR Codeã€‚';
        }
      } catch (err) {
        console.error('[SCAN] Error during scan process:', err);
        alert(`æƒææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n${err.message}`);
        // ç™¼ç”ŸéŒ¯èª¤å¾Œï¼Œä¹Ÿè¦é‡æ–°å•Ÿç”¨æŒ‰éˆ•
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('status').textContent = 'æƒæå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
      }
    }
  </script>
</body>
</html>